# نظام المصادقة الموحد

## نظرة عامة

يستخدم التطبيق نظام مصادقة موحد يعتمد على Firebase Authentication وFirestore. تم تصميم النظام للتحقق من هوية المستخدمين وإدارة الصلاحيات بطريقة مركزية وفعالة.

## الملفات الرئيسية

- `contexts/UnifiedAuthContext.jsx`: السياق الرئيسي للمصادقة الذي يوفر جميع وظائف المصادقة والتحقق من الصلاحيات.
- `firebase.jsx`: يحتوي على وظائف التفاعل مع Firebase Authentication وFirestore.

## الوظائف الرئيسية

### المصادقة

- `signIn(email, password)`: تسجيل الدخول باستخدام البريد الإلكتروني وكلمة المرور.
- `signOut()`: تسجيل الخروج وإزالة بيانات المستخدم من الذاكرة المحلية.

### إدارة الصلاحيات

- `checkPermission(permission)`: التحقق مما إذا كان المستخدم يملك صلاحية معينة.
- `canAccessSection(section)`: التحقق مما إذا كان المستخدم يمكنه الوصول إلى قسم معين.

## آلية عمل النظام

1. **تسجيل الدخول**:
   - التحقق من صحة بيانات الاعتماد باستخدام Firebase Authentication.
   - البحث عن المستخدم في جدول `users` باستخدام البريد الإلكتروني.
   - إذا لم يتم العثور على المستخدم، يتم البحث في جدول `employees`.
   - إذا تم العثور على الموظف، يتم إنشاء سجل جديد في جدول `users`.
   - التحقق من حالة المستخدم (نشط/غير نشط).
   - تخزين بيانات المستخدم في الذاكرة المحلية وحالة التطبيق.

2. **التحقق من الصلاحيات**:
   - المستخدمون ذوو الدور "admin" أو الذين لديهم صلاحية "all" يمكنهم الوصول إلى جميع الأقسام.
   - يتم التحقق من الصلاحيات المحددة للمستخدمين الآخرين.
   - يتم تعريف الصلاحيات المطلوبة لكل قسم في دالة `canAccessSection`.

3. **حماية المسارات**:
   - يتم استخدام مكون `ProtectedRoute` للتحقق من صلاحيات المستخدم قبل السماح بالوصول إلى المسارات المحمية.
   - يمكن تحديد الدور المطلوب أو الصلاحية المطلوبة أو القسم المطلوب للوصول إلى المسار.

## مثال على الاستخدام

```jsx
// استخدام سياق المصادقة في مكون
import { useAuth } from '../contexts/UnifiedAuthContext';

const MyComponent = () => {
  const { user, signIn, signOut, checkPermission } = useAuth();

  // التحقق من تسجيل الدخول
  if (!user) {
    return <div>يرجى تسجيل الدخول</div>;
  }

  // التحقق من الصلاحيات
  if (!checkPermission('view_dashboard')) {
    return <div>ليس لديك صلاحية للوصول إلى هذه الصفحة</div>;
  }

  return (
    <div>
      <h1>مرحباً {user.name}</h1>
      <button onClick={signOut}>تسجيل الخروج</button>
    </div>
  );
};
```

## ملاحظات هامة

- يجب استخدام `useAuth()` للوصول إلى سياق المصادقة في المكونات.
- يجب استخدام `AuthProvider` لتغليف التطبيق في الجذر (في ملف `main.jsx`).
- يجب التحقق من وجود المستخدم قبل محاولة الوصول إلى خصائصه.
- يجب استخدام `ProtectedRoute` لحماية المسارات التي تتطلب مصادقة أو صلاحيات محددة.
